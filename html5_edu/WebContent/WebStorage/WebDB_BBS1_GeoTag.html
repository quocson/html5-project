<!DOCTYPE html>
<html lang="en">
<head>

      <!-- Meta -->
			<meta charset="UTF-8">
      <title>W3Labs.kr</title>

      <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
      
      <!-- 공통 CSS -->
      <link rel="stylesheet" href="../resources/css/reset.css" media="all">
      <link rel="stylesheet" href="../resources/css/fonts.css" media="all">
      <link rel="stylesheet" href="../resources/css/style.css" media="all">
      
      <!-- Media Queries -->
      <link rel="stylesheet" href="../resources/css/10col.css" media="only screen and (min-width: 992px)">
      <link rel="stylesheet" href="../resources/css/8col.css" media="only screen and (min-width: 768px) and (max-width: 991px)">
      <link rel="stylesheet" href="../resources/css/3col.css" media="only screen and (max-width: 767px)">
      <link rel="stylesheet" href="../resources/css/5col.css" media="only screen and (min-width: 480px) and (max-width: 767px)">

      <!-- 스마트폰 대응. 최대확대:3배까지 , 확대/축소:가능 -->
      <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=3.0; user-scalable=yes">
      <!-- Add "maximum-scale=1.0, user-scalable=no" to fix the Mobile Safari auto-zoom bug on orientation changes, but keep in mind that it will disable user-zooming completely. Bad for accessibility. -->   
     
      <!-- 아이콘 16x16 -->
      <link rel="shortcut icon" href="http://w3labs.kr/wp-content/uploads/2011/01/logo_temp.png" type="image/x-icon">
      <link rel="icon" href="http://w3labs.kr/wp-content/uploads/2011/01/logo_temp.png" type="image/x-icon">
      
      <!-- 아이콘 Apple 144x144 -->
      <link rel="apple-touch-icon" sizes="114x114" href="http://w3labs.kr/wp-content/uploads/2011/01/logo_temp.png"> 
      
      <!-- iOS에서 웹페이지를 [홈 화면에 추가] -->
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="black">
      <link rel="apple-touch-startup-image" href="http://w3labs.kr/wp-content/uploads/2011/01/logo_temp.png">
                   
      <meta name="description" content="W3Labs.kr Demo & Samples Site">
      <meta name="keywords" content="w3labs.kr html5 sencha touch phonegap">
                 
      <!-- Jquery -->
      <script src="../resources/js/jquery-1.6.1.min.js"></script>
      
      <!-- Google Map API -->
      <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
			<script> 
				var db = window.openDatabase("bbsTable", "1.0", "bbsTable Description", 1024);
				var prevCount, newCount;
				
				function init() {
				  if (!window.openDatabase) {
					    status("Database not supported");
					    return;
					}
				  
				  if (navigator.geolocation){
						//locate position
						navigator.geolocation.getCurrentPosition(displayPosition, errorFunction);
					}
					else{
						alert('Geolocation 기능을 지원하지 않는 브라우저 입니다.');
					}
				  
					db.transaction(function(tx) {
					   // tx.executeSql("drop table if exists bbsTable");
					   tx.executeSql("create table if not exists bbsTable ("
					     + "id integer primary key,"
					     + "title text,"
					     + "user_name text,"
					     + "create_date text,"
					     + "content text,"
					     + "latitude text,"
					     + "longitude text"
					     + ")",null,null, logger);
					   showRecords();
					   console.log("doffo");
					 });
					
					 setInterval( 'checkCount()',3000 );
				}
				
				function displayPosition(pos){
					var myLat = pos.coords.latitude;
					var myLong = pos.coords.longitude;
					
					document.getElementById("latitude").value = myLat;
					document.getElementById("longitude").value = myLong;
				}
				 
				//error callback function
				function errorFunction(pos){
					alert('Error!');
				}
				
				
				function checkCount() {
					prevCount = document.getElementsByName('bbs').length;
					console.log(prevCount);
					
			    db.transaction(function(tx) {
				      tx.executeSql("select count(1) as cnt from bbsTable", [], function(tx, results) {
				        newCount = results.rows.item(0).cnt;
								console.log('newCount : ' + newCount);
								console.log('prevCount : ' + prevCount);
								if( newCount > prevCount)
									displayNewMsg();
				      });
				  });
				}

				function displayNewMsg() {
					var text = '<div class="h2_cont" style="border-top: 0px; margin: 10px 0 10px 0" name="bbs" id=newMsg>';
					    text += '<h3 style="padding: 5px 0 5px 5px">  <a onClick="getNewMsg();">새로온 메세지가 있습니다.</a> </h3></div>';
					var textHide = $(text).hide();
					textHide.prependTo($('#services')).slideDown();
				}

				function getNewMsg() {
			    html = "";
			    db.transaction(function(tx) {
			      tx.executeSql("select * from bbsTable", [], function(tx, results) {
			    	  console.log( 'prevCount-1 : ' + (prevCount-1) );
			    	  console.log( 'results.rows.length : ' + results.rows.length );
			        for (var i=prevCount; i<results.rows.length; i++) {
			          var record = results.rows.item(i);
			            
			      	 	html += '<div class="h2_cont" style="border-top: 0px; margin: 10px 0 10px 0"  name="bbs">';
			      	 	html += '<h3 style="padding: 5px 0 5px 5px">';
			      	 	html += record.user_name + ' : ' + record.title;
			      	 	html += '</h3>';
			      	 	html += record.content + ' - ' + record.create_date + " <button id='"+record.id+"' class='remove' onClick='recordsOnClick(this)';>x</button> ";
			      	 	html += '</div>';
			        }
			        var htmlHide = $(html).hide();
			        $('#newMsg').slideDown().hide();
			        htmlHide.prependTo($('#services')).slideDown();
			      });
			    });
				}
				
				function status(status) {
				  document.getElementById("status").innerHTML = status;
				}
				function logger(tx, error) {
				  console.log("Error", error.message);
				}
				function logArguments() {
				  console.log(arguments);
				}
				function $_(selector) {
				  return document.querySelector(selector);
				}
				
				function save() {
					db.transaction(function(tx) {
				    console.log("running2");
				    tx.executeSql(
				        "insert into bbsTable (title, user_name, create_date, content, latitude, longitude) "
				      + "values (?,?,?,?,?,?)", [$_("#title").value, $_("#userName").value, $_("#createDate").value, $_("#content").value, $_("#latitude").value, $_("#longitude").value],
				      null, logger
				    );
				    console.log("done");
				    showRecords();
				  });
				};
				
			  function ageOnKeyUp(ev) {
				    if (ev.keyCode==13) $_("#save").onclick();
				};
				 
				
			  function recordsOnClick(o) {
			    if (o.className!="remove") return;
			    var recordID = o.id;
			    console.log(recordID);
			    db.transaction(function(tx) {
			      tx.executeSql("delete from bbsTable where id=?", [recordID], null, logger);
			      showRecords();
			    });
			  }
				
				
				function showRecords() {
			    console.log("db", db);
			    html = "";
			    db.transaction(function(tx) {
			      tx.executeSql("select * from bbsTable order by id desc", [], function(tx, results) {
			        for (var i=0; i<results.rows.length; i++) {
			          var record = results.rows.item(i);
			            
			      	 	html += '<div class="h2_cont" style="border-top: 0px; margin: 10px 0 10px 0"  name="bbs">';
			      	 	html += '<h3 style="padding: 5px 0 5px 5px">';
			      	 	html += record.user_name + ' : ' + record.title;
			      	 	html += '</h3>';
			      	 	html += record.content + ' - ' + record.create_date + ' - <span onClick="displayMap(\''+record.latitude+'\',\''+record.longitude+'\');">GeoTag</span> ' + " <button id='"+record.id+"' class='remove' onClick='recordsOnClick(this)';>x</button> ";
			      	 	html += '</div>';
			        }
			        $_("#records").innerHTML = html;
			      });
			    });
			  }
				
				function displayMap(latitude, longitude) {
					var latlng = new google.maps.LatLng(latitude, longitude);
					var myOptions = {
					  zoom: 15,
					  center: latlng,
					  //mapTypeId: google.maps.MapTypeId.HYBRID
					  mapTypeId: google.maps.MapTypeId.ROADMAP
					};
					
					var html = "<div id=geoTag style='height:300px; width:400px'>111</div>"
					var divHide = $(html);
			    divHide.prependTo($('#menu1'));
					var map = new google.maps.Map(document.getElementById("geoTag"), myOptions);
					
					//Add marker
					var marker = new google.maps.Marker({
						     position: latlng, 
						     map: map, 
						     title:"You are here"
						 });    
				}
				
			</script> 
      
</head>
<body onLoad="init();">

	 <header id="top">
         <h1>w3labs.kr <small>Demo <em>&amp;</em> Samples</small></h1>
         <div id="say_hello">
         	<p>say hello!</p>
            <div id="hello">
         		<a href="mailto:contact@w3labs.kr">contact@w3labs.kr</a>
            	<a href="tel:+07075142739">070.7514.2739</a>
            </div>
         </div>
     </header><!-- end #header -->
      
     <section id="services">
     <!--  
     	 <div class="h2_cont"  style="border-top: 0px; margin: 10px 0 10px 0" name='bbs'>
         	<h3 style="padding: 5px 0 5px 5px">CSS3 Demo : </h3>동해물과 백두산이 마르고 닳도록 하느님이 보우하사 
       </div>
     	 <div class="h2_cont" style="border-top: 0px; margin: 10px 0 10px 0"  name='bbs'>
         	<h3 style="padding: 5px 0 5px 5px">CSS3 Demo : </h3>동해물과 백두산이 마르고 닳도록 하느님이 보우하사 
       </div>
       -->
       <p id="records"></p> 
 
<div id="status"> 
         
     </section><!-- end #services -->
     
     
          
          
     <section id="services">
	      <div class="third" style="width:500px;">
	      	<h3><span>1.</span>  새글쓰기</h3>
	         <ul id=menu1>
							<li>User Name : <input type=text id=userName size=30></li>
							<li>Title : <input type=text id=title size=30></li>
							<li>Create Date : <input type=text id=createDate size=30></li>
							<li>Content : <textarea type=text id=content size=30></textarea></li>
							<li>Latitude : <input type=text id=latitude size=30></li>
							<li>Longitude : <input type=text id=longitude size=30></li>
	          </ul>
	          <ul>
	          	<button id="save" onClick="save();">Save</button> 
	          </ul>
	      </div>
     </section><!-- end #clients -->
     
     
     <footer>
     	 
         <a href="#top"><img src="../resources/img/top.jpg" alt="back-to-top"></a>
         <p>Built with HTML5, CSS3, Typekit &amp; Media Queries</p>
         
     </footer><!-- end #footer -->
   
</body></html>